<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vite + Vue + TS</title>
</head>

<body>
  <div id="app"></div>
  <script type="module" src="/src/main.ts"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>

  <script>
    function connectionFactory() {
      var options = {
        protocols_whitelist: ['websocket', 'xdr-streaming', 'xhr-streaming', 'iframe-eventsource', 'xdr-polling', 'xhr-polling'],
        debug: true,
        jsessionid: false,
        server_heartbeat_interval: 4000,
        heartbeatTimeout: 2000
      };

      const stream = 'https://streaming.forexpros.com'
      const sock = new SockJS(stream + '/echo', null, options);

      sock.onopen = function () {
        var TimeZoneID = 12;

        const pids = [
          "pid-8839:",
          "pid-941612:",
          "pid-2103:",
          "pid-8873:",
          "pid-8874:",
          "pid-8849:",
          "pid-8830:",
          "pid-1:",
          "pid-8827:",
        ];

        pids.forEach((val) => {
          sock.send(JSON.stringify({ _event: "subscribe", "tzID": TimeZoneID, "message": val }));
        })
      };

      sock.onmessage = function (event) {
        try {
          const content = JSON.parse(event.data);
          const serializedMsg = content.message.split('::');
          const serializedObj = JSON.parse(serializedMsg[1]);
          console.log({ serializedObj });
        }

        catch (err) {
          console.error('Houve um problema ao serializar a mensagem: ' + err.message + event.data);
          sock.close();
        }
      };

      sock.onclose = function () {
        console.log('Closing websocket...');
      }
    }

    connectionFactory()
  </script>
</body>

</html>